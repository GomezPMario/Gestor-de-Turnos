<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mi Gestor de Turnos</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* ðŸ“Œ Calendario SIN alturas fijas */
        #calendarGrid>div {
            aspect-ratio: 1 / 1;
            min-height: 0;
        }

        .selected-shift {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #2563eb !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .selected-shift::after {
            content: 'âœ“';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        #shiftOptionsContainer button {
            transition: all 0.15s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900">

    <!-- ðŸ”µ LOADER -->
    <div id="loadingSpinner" class="flex items-center justify-center h-screen w-screen">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="mt-4 text-lg font-medium text-gray-700">Cargando tu gestor de turnos...</p>
        </div>
    </div>

    <!-- ðŸ”µ APLICACIÃ“N COMPLETA (pantalla 100% sin scroll) -->
    <div id="appContent" class="hidden h-screen flex flex-col overflow-hidden">

        <!-- ðŸ”µ HEADER -->
        <header class="flex items-center justify-between px-4 py-2 border-b border-gray-300 flex-none">
            <h1 class="text-2xl font-bold text-blue-700">Mi Gestor de Turnos</h1>

            <div class="flex items-center space-x-2">
                <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                </button>

                <h2 id="monthYear" class="text-lg font-semibold w-40 text-center"></h2>

                <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- ðŸ”µ CALENDARIO (ocupa todo el espacio restante) -->
        <main class="flex-1 overflow-hidden p-2">
            <div id="calendarGrid"
                class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden h-full shadow-lg">
            </div>
        </main>

    </div>

    <!-- ðŸ”µ MODAL -->
    <div id="shiftModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md">
            <form id="shiftForm">
                <div class="flex items-center justify-between p-5 border-b border-gray-200">
                    <h3 id="modalTitle" class="text-xl font-semibold">AÃ±adir Turno</h3>
                    <button type="button" id="closeModal"
                        class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>

                <div class="p-6 space-y-4">
                    <div>
                        <label for="shiftDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="shiftDate" name="shiftDate" readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 focus:outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Turno(s)</label>
                        <div id="shiftOptionsContainer" class="grid grid-cols-3 gap-2">
                            <button type="button" data-name="MaÃ±ana"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-yellow-400 text-black hover:bg-yellow-500">M</button>
                            <button type="button" data-name="Tarde"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-rose-400 text-black hover:bg-rose-500">T</button>
                            <button type="button" data-name="Noche"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-blue-400 text-black hover:bg-blue-500">N</button>
                            <button type="button" data-name="Central"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-sky-500 text-black hover:bg-sky-600">C</button>
                            <button type="button" data-name="Vacaciones"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-orange-400 text-black hover:bg-orange-500">Vac</button>
                            <button type="button" data-name="Libre"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-medium bg-gray-500 text-white hover:bg-gray-600">Libre</button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between p-5 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                    <button type="button" id="deleteButton"
                        class="hidden px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 focus:outline-none transition-colors">Limpiar
                        DÃ­a</button>
                    <div class="flex-grow flex justify-end space-x-3">
                        <button type="button" id="cancelButton"
                            class="px-4 py-2 bg-white text-gray-700 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ðŸ”µ JAVASCRIPT (todo tu cÃ³digo original completo, sin recortes) -->
    <script>
        /* ---------- CONFIG ------------- */
        const API_BASE = "http://mynas.local:8090";
        const COLLECTION = "shifts";
        const API_URL = `${API_BASE}/api/collections/${COLLECTION}/records`;

        /* ---------- Estado y DOM ---------- */
        let allShifts = [];
        let currentDate = new Date();

        const monthYearDisplay = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const modal = document.getElementById('shiftModal');
        const modalTitle = document.getElementById('modalTitle');
        const shiftForm = document.getElementById('shiftForm');
        const shiftDateInput = document.getElementById('shiftDate');
        const shiftOptionsContainer = document.getElementById('shiftOptionsContainer');
        const deleteButton = document.getElementById('deleteButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const appContent = document.getElementById('appContent');

        document.addEventListener('DOMContentLoaded', initApp);

        function showApp() {
            loadingSpinner.classList.add('hidden');
            appContent.classList.remove('hidden');
        }

        async function initApp() {
            try {
                document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
                document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
                document.getElementById('closeModal').addEventListener('click', closeModal);
                document.getElementById('cancelButton').addEventListener('click', closeModal);
                shiftForm.addEventListener('submit', saveShift);
                deleteButton.addEventListener('click', deleteDayShifts);
                setupOptionButtons();

                await loadShifts();
                showApp();
                renderCalendar();
                setInterval(loadShifts, 5000);

            } catch (err) {
                console.error("Init error:", err);
                loadingSpinner.innerText = "Error al cargar la app. Revisa consola.";
            }
        }

        async function loadShifts() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                allShifts = data.items.map(i => ({ id: i.id, date: i.date, name: i.name }));
                renderCalendar();
            } catch (err) {
                console.error(err);
            }
        }

        async function createShift(record) {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(record)
            });
            return res.json();
        }

        async function deleteShift(id) {
            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            return true;
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthYearDisplay.textContent = new Date(year, month).toLocaleDateString('es-ES', {
                month: 'long',
                year: 'numeric'
            });

            calendarGrid.innerHTML = '';

            const weekDays = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
            weekDays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = "text-center font-semibold text-gray-600 text-sm";
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });

            const firstDay = new Date(year, month, 1);
            let dayOfWeek = firstDay.getDay();
            let startOffset = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const prevMonth = new Date(year, month, 0);
            const daysInPrevMonth = prevMonth.getDate();
            const prevYear = prevMonth.getFullYear();
            const prevMonthNum = prevMonth.getMonth();

            for (let i = 0; i < startOffset; i++) {
                const day = daysInPrevMonth - startOffset + 1 + i;
                calendarGrid.appendChild(createDayCell(prevYear, prevMonthNum, day, true));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                calendarGrid.appendChild(createDayCell(year, month, day, false));
            }

            const nextMonth = new Date(year, month + 1, 1);
            const nextYear = nextMonth.getFullYear();
            const nextMonthNum = nextMonth.getMonth();

            const totalCellsRendered = startOffset + daysInMonth;
            let day = 1;
            while (totalCellsRendered + day - 1 < 42) {
                calendarGrid.appendChild(createDayCell(nextYear, nextMonthNum, day, true));
                day++;
            }
        }

        function getShiftDisplay(name) {
            const n = name.toLowerCase();
            if (n.includes("maÃ±ana")) return { text: "M", colorClasses: "bg-yellow-400 text-black" };
            if (n.includes("tarde")) return { text: "T", colorClasses: "bg-rose-400 text-black" };
            if (n.includes("noche")) return { text: "N", colorClasses: "bg-blue-400 text-black" };
            if (n.includes("central")) return { text: "C", colorClasses: "bg-sky-500 text-black" };
            if (n.includes("vacaciones")) return { text: "Vac", colorClasses: "bg-orange-400 text-black" };
            if (n.includes("libre")) return { text: "Libre", colorClasses: "bg-gray-500 text-white" };
            return { text: name, colorClasses: "bg-gray-300 text-black" };
        }

        function createDayCell(year, month, day, isOtherMonth = false) {
            const cell = document.createElement('div');
            const date = new Date(year, month, day);
            const dateString = date.toISOString().split('T')[0];

            cell.className =
                "border border-gray-200 relative hover:bg-blue-50 cursor-pointer transition-colors flex flex-col";

            const dayNumber = document.createElement('span');
            dayNumber.className = "font-medium text-sm p-1";
            dayNumber.textContent = day;

            if (isOtherMonth) {
                cell.classList.add('bg-gray-100');
                dayNumber.classList.add('text-gray-400');
            } else {
                cell.classList.add('bg-white');
            }

            const shiftsContainer = document.createElement('div');
            shiftsContainer.className = "flex-1 flex flex-col";

            const dayShifts = allShifts.filter(s => s.date === dateString);

            if (dayShifts.length === 1) {
                const disp = getShiftDisplay(dayShifts[0].name);
                const shiftEl = document.createElement('div');
                shiftEl.className =
                    `w-full h-full flex items-center justify-center font-bold text-2xl ${disp.colorClasses}`;
                shiftEl.textContent = disp.text;
                shiftsContainer.appendChild(shiftEl);
            } else if (dayShifts.length === 2) {
                dayShifts.forEach(shift => {
                    const disp = getShiftDisplay(shift.name);
                    const shiftEl = document.createElement('div');
                    shiftEl.className =
                        `w-full h-1/2 flex items-center justify-center font-bold text-lg ${disp.colorClasses}`;
                    shiftEl.textContent = disp.text;
                    shiftsContainer.appendChild(shiftEl);
                });
            } else if (dayShifts.length > 2) {
                shiftsContainer.className = "flex-1 overflow-y-auto p-1 text-xs space-y-1";
                dayShifts.forEach(shift => {
                    const disp = getShiftDisplay(shift.name);
                    const shiftEl = document.createElement('div');
                    shiftEl.className = `rounded p-1 text-center font-medium ${disp.colorClasses}`;
                    shiftEl.textContent = disp.text;
                    shiftsContainer.appendChild(shiftEl);
                });
            }

            cell.appendChild(dayNumber);
            cell.appendChild(shiftsContainer);
            cell.addEventListener('click', () => openModal(dateString, dayShifts));
            return cell;
        }

        function openModal(dateString, dayShifts = []) {
            modal.classList.remove('hidden');
            shiftForm.reset();
            shiftDateInput.value = dateString;

            const ids = dayShifts.map(s => s.id);
            shiftForm.dataset.existingIds = JSON.stringify(ids);

            document.querySelectorAll('#shiftOptionsContainer button')
                .forEach(b => b.classList.remove('selected-shift'));

            dayShifts.forEach(s => {
                const btn = document.querySelector(`#shiftOptionsContainer button[data-name="${s.name}"]`);
                if (btn) btn.classList.add('selected-shift');
            });

            deleteButton.classList.toggle('hidden', ids.length === 0);
        }

        function closeModal() {
            modal.classList.add('hidden');
            shiftForm.reset();
        }

        function setupOptionButtons() {
            shiftOptionsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn) btn.classList.toggle('selected-shift');
            });
        }

        async function saveShift(e) {
            e.preventDefault();
            const date = shiftDateInput.value;
            const oldIds = JSON.parse(shiftForm.dataset.existingIds || "[]");

            for (const id of oldIds) try { await deleteShift(id); } catch { }

            const selected = document.querySelectorAll('#shiftOptionsContainer button.selected-shift');
            for (const b of selected) {
                await createShift({ date, name: b.dataset.name });
            }

            await loadShifts();
            closeModal();
        }

        async function deleteDayShifts() {
            const ids = JSON.parse(shiftForm.dataset.existingIds || "[]");
            for (const id of ids) try { await deleteShift(id); } catch { }
            await loadShifts();
            closeModal();
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }
    </script>
</body>

</html>