<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mi Gestor de Turnos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        #calendarGrid>div {
            min-height: 120px;
        }

        .selected-shift {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #2563eb !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .selected-shift::after {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        #shiftOptionsContainer button {
            transition: all 0.15s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900">
    <div id="loadingSpinner" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="mt-4 text-lg font-medium text-gray-700">Cargando tu gestor de turnos...</p>
        </div>
    </div>

    <div id="appContent" class="hidden max-w-lg mx-auto p-4 md:p-8">
        <header class="flex items-center justify-between mb-6 pb-4 border-b border-gray-300">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-700">Mi Gestor de Turnos</h1>
            <div class="flex items-center space-x-2">
                <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                </button>
                <h2 id="monthYear" class="text-xl font-semibold w-48 text-center"></h2>
                <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <div id="calendarGrid"
                class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden shadow-lg">
            </div>
        </main>
    </div>

    <div id="shiftModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md">
            <form id="shiftForm">
                <div class="flex items-center justify-between p-5 border-b border-gray-200">
                    <h3 id="modalTitle" class="text-xl font-semibold">Añadir Turno</h3>
                    <button type="button" id="closeModal"
                        class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>

                <div class="p-6 space-y-4">
                    <div>
                        <label for="shiftDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="shiftDate" name="shiftDate" readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 focus:outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Turno(s)</label>
                        <div id="shiftOptionsContainer" class="grid grid-cols-3 gap-2">
                            <button type="button" data-name="Mañana"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-yellow-400 text-black hover:bg-yellow-500">M</button>
                            <button type="button" data-name="Tarde"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-rose-400 text-black hover:bg-rose-500">T</button>
                            <button type="button" data-name="Noche"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-blue-400 text-black hover:bg-blue-500">N</button>
                            <button type="button" data-name="Central"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-sky-500 text-black hover:bg-sky-600">C</button>
                            <button type="button" data-name="Vacaciones"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-bold bg-orange-400 text-black hover:bg-orange-500">Vac</button>
                            <button type="button" data-name="Libre"
                                class="p-3 border-2 border-gray-300 rounded-lg text-center font-medium bg-gray-500 text-white hover:bg-gray-600">Libre</button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between p-5 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                    <button type="button" id="deleteButton"
                        class="hidden px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700 focus:outline-none transition-colors">Limpiar
                        Día</button>
                    <div class="flex-grow flex justify-end space-x-3">
                        <button type="button" id="cancelButton"
                            class="px-4 py-2 bg-white text-gray-700 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        /* ---------- CONFIG ------------- */
        /* Cambia esto por la URL de tu PocketBase (puede ser hostname local o dominio público con proxy/HTTPS) */
        const API_BASE = "http://mynas.local:8090"; // <- cambia por tu URL
        const COLLECTION = "shifts";
        const API_URL = `${API_BASE}/api/collections/${COLLECTION}/records`;

        /* ---------- Estado y DOM ---------- */
        let allShifts = [];
        let currentDate = new Date();

        const monthYearDisplay = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const modal = document.getElementById('shiftModal');
        const modalTitle = document.getElementById('modalTitle');
        const shiftForm = document.getElementById('shiftForm');
        const shiftDateInput = document.getElementById('shiftDate');
        const shiftOptionsContainer = document.getElementById('shiftOptionsContainer');
        const deleteButton = document.getElementById('deleteButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const appContent = document.getElementById('appContent');

        /* ---------- Init ---------- */
        document.addEventListener('DOMContentLoaded', initApp);

        function showApp() {
            loadingSpinner.classList.add('hidden');
            appContent.classList.remove('hidden');
        }

        async function initApp() {
            try {
                // event listeners UI
                document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
                document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
                document.getElementById('closeModal').addEventListener('click', closeModal);
                document.getElementById('cancelButton').addEventListener('click', closeModal);
                shiftForm.addEventListener('submit', saveShift);
                deleteButton.addEventListener('click', deleteDayShifts);
                setupOptionButtons();

                // Cargar datos iniciales
                await loadShifts();

                // Polling sencillo para ver cambios (5s) — puedes aumentar o reemplazar por realtime
                setInterval(loadShifts, 5000);

                showApp();
            } catch (err) {
                console.error("Init error:", err);
                loadingSpinner.innerText = "Error al cargar la app. Revisa consola.";
            }
        }

        /* ---------- PocketBase API helpers ---------- */
        async function loadShifts() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("Error cargando turnos: " + res.status);
                const data = await res.json();
                // PocketBase devuelve objetos en data.items
                allShifts = data.items.map(i => ({
                    id: i.id,
                    date: i.date, // PocketBase date string
                    name: i.name
                }));
                renderCalendar();
            } catch (err) {
                console.error(err);
            }
        }

        async function createShift(record) {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(record)
            });
            if (!res.ok) throw new Error('Failed to create record: ' + res.status);
            return res.json();
        }

        async function deleteShift(id) {
            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete record: ' + res.status);
            return true;
        }

        /* ---------- Calendar rendering (tu código adaptado) ---------- */

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthYearDisplay.textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';

            const weekDays = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
            weekDays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = "text-center font-semibold text-gray-600 text-sm";
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });

            const firstDay = new Date(year, month, 1);
            let dayOfWeek = firstDay.getDay();
            let startOffset = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const prevMonth = new Date(year, month, 0);
            const daysInPrevMonth = prevMonth.getDate();
            const prevMonthYear = prevMonth.getFullYear();
            const prevMonthMonth = prevMonth.getMonth();

            for (let i = 0; i < startOffset; i++) {
                const day = daysInPrevMonth - startOffset + 1 + i;
                calendarGrid.appendChild(createDayCell(prevMonthYear, prevMonthMonth, day, true));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                calendarGrid.appendChild(createDayCell(year, month, day, false));
            }

            const nextMonth = new Date(year, month + 1, 1);
            const nextMonthYear = nextMonth.getFullYear();
            const nextMonthMonth = nextMonth.getMonth();

            const totalCellsRendered = startOffset + daysInMonth;
            const targetCells = 42;
            let day = 1;
            while (totalCellsRendered + day - 1 < targetCells) {
                calendarGrid.appendChild(createDayCell(nextMonthYear, nextMonthMonth, day, true));
                day++;
            }
        }

        function getShiftDisplay(name) {
            const normalizedName = name.toLowerCase().trim();
            let text = name;
            let colorClasses = "bg-gray-300 text-black";

            if (normalizedName.includes('mañana')) {
                text = "M"; colorClasses = "bg-yellow-400 text-black";
            } else if (normalizedName.includes('tarde')) {
                text = "T"; colorClasses = "bg-rose-400 text-black";
            } else if (normalizedName.includes('noche')) {
                text = "N"; colorClasses = "bg-blue-400 text-black";
            } else if (normalizedName.includes('central')) {
                text = "C"; colorClasses = "bg-sky-500 text-black";
            } else if (normalizedName.includes('vacaciones')) {
                text = "Vac"; colorClasses = "bg-orange-400 text-black";
            } else if (normalizedName.includes('libre')) {
                text = "Libre"; colorClasses = "bg-gray-500 text-white";
            } else {
                if (name.length > 5) text = name.substring(0, 3);
            }
            return { text, colorClasses };
        }

        function createDayCell(year, month, day, isOtherMonth = false) {
            const cell = document.createElement('div');
            const date = new Date(year, month, day);
            const dateString = date.toISOString().split('T')[0];

            cell.className = "border border-gray-200 min-h-[100px] md:min-h-[120px] relative hover:bg-blue-50 cursor-pointer transition-colors duration-200 flex flex-col";

            const dayNumber = document.createElement('span');
            dayNumber.className = "font-medium text-sm p-2";
            dayNumber.textContent = day;

            if (isOtherMonth) {
                cell.classList.add('bg-gray-100');
                dayNumber.classList.add('text-gray-400');
            } else {
                cell.classList.add('bg-white');
            }

            const shiftsContainer = document.createElement('div');
            const dayShifts = allShifts.filter(shift => shift.date === dateString);

            if (dayShifts.length === 1) {
                shiftsContainer.className = "flex-grow flex";
                const shift = dayShifts[0];
                const display = getShiftDisplay(shift.name);
                const shiftEl = document.createElement('div');
                shiftEl.className = `w-full h-full flex items-center justify-center font-bold text-3xl ${display.colorClasses}`;
                shiftEl.textContent = display.text;
                shiftsContainer.appendChild(shiftEl);
            } else if (dayShifts.length === 2) {
                shiftsContainer.className = "flex-grow flex flex-col";
                dayShifts.forEach(shift => {
                    const display = getShiftDisplay(shift.name);
                    const shiftEl = document.createElement('div');
                    shiftEl.className = `w-full h-1/2 flex items-center justify-center font-bold text-lg ${display.colorClasses}`;
                    shiftEl.textContent = display.text;
                    shiftsContainer.appendChild(shiftEl);
                });
            } else if (dayShifts.length > 2) {
                shiftsContainer.className = "flex-grow overflow-y-auto text-xs mt-1 p-1 space-y-1";
                dayShifts.forEach(shift => {
                    const display = getShiftDisplay(shift.name);
                    const shiftEl = document.createElement('div');
                    shiftEl.className = `rounded p-1 text-center font-medium ${display.colorClasses}`;
                    shiftEl.textContent = display.text;
                    shiftsContainer.appendChild(shiftEl);
                });
            }

            cell.appendChild(dayNumber);
            cell.appendChild(shiftsContainer);

            cell.addEventListener('click', () => {
                openModal(dateString, dayShifts);
            });

            return cell;
        }

        /* ---------- Modal y formularios ---------- */

        function openModal(dateString, dayShifts = []) {
            modal.classList.remove('hidden');
            shiftForm.reset();
            shiftForm.dataset.id = '';

            shiftDateInput.value = dateString;
            modalTitle.textContent = "Editar Turnos del Día";

            // limpiar selecciones previas
            document.querySelectorAll('#shiftOptionsContainer button').forEach(btn => {
                btn.classList.remove('selected-shift');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });

            const existingIds = [];
            dayShifts.forEach(shift => {
                const btnToSelect = document.querySelector(`#shiftOptionsContainer button[data-name="${shift.name}"]`);
                if (btnToSelect) btnToSelect.classList.add('selected-shift');
                existingIds.push(shift.id);
            });

            shiftForm.dataset.existingIds = JSON.stringify(existingIds);

            if (existingIds.length > 0) {
                deleteButton.classList.remove('hidden');
                deleteButton.textContent = 'Limpiar Día';
            } else {
                deleteButton.classList.add('hidden');
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
            shiftForm.reset();
            shiftForm.dataset.id = '';
            shiftForm.dataset.existingIds = '[]';
        }

        function setupOptionButtons() {
            shiftOptionsContainer.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target || target.disabled) return;
                target.classList.toggle('selected-shift');
            });
        }

        /* ---------- Guardar / borrar usando PocketBase ---------- */

        async function saveShift(e) {
            e.preventDefault();
            const date = shiftDateInput.value;
            if (!date) { console.warn("La fecha es obligatoria."); return; }

            const oldShiftIds = JSON.parse(shiftForm.dataset.existingIds || '[]');
            const selectedBtns = document.querySelectorAll('#shiftOptionsContainer button.selected-shift');
            const newShiftNames = Array.from(selectedBtns).map(btn => btn.dataset.name);

            try {
                // borrar antiguos
                for (const id of oldShiftIds) {
                    try { await deleteShift(id); } catch (err) { console.warn("No se pudo borrar id", id, err); }
                }

                // añadir nuevos
                for (const name of newShiftNames) {
                    await createShift({ date, name });
                }

                await loadShifts();
                closeModal();
            } catch (err) {
                console.error("Error al guardar los turnos:", err);
            }
        }

        async function deleteDayShifts() {
            const shiftIds = JSON.parse(shiftForm.dataset.existingIds || '[]');
            if (shiftIds.length === 0) return;

            try {
                for (const id of shiftIds) {
                    try { await deleteShift(id); } catch (err) { console.warn("No se pudo borrar", id, err); }
                }
                await loadShifts();
                closeModal();
            } catch (err) {
                console.error("Error al eliminar los turnos del día:", err);
            }
        }

        /* ---------- Utilidades de mes ---------- */
        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }
    </script>
</body>

</html>